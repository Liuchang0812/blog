

在使用 [libco][1] 的时候，不正确的用法会导致协程调度不正常。分享最近遇到的问题。

<!--more-->

在协程环境下，调用了使用标准锁的函数。



RPC 框架是一个多线程多协程的模型，在一个线程下会开启多个协程，请求来了之后会由协程调用业务处理函数。最近加了一个并发优化后，发现会出现请求卡住不呼应的问题。



最终定位到就是：在协程环境下使用了`std::mutex`，并发的 RPC 请求可能会调用到同一个线程的两个协程内。我们称这两个协程为 A 和 B。第一个请求时，A 协程拿了锁，然后向另外一个服务发送了网络请求。这个时候协程A因为IO被挂起，切换到协程B，协程B又尝试对mutex加锁。同一个线程下两次调用，这个协程B就永远卡死了。因为协程B一直卡着，协程A也没办法被调度回来。现象上看，这个处理线程完全卡死，两个请求不响应。



解决办法就是使用协程自带的锁，避免线程级的锁。



[1]: https://github.com/Tencent/libco	"libco"

